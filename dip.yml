version: '2'

environment:
  DOCKER_TLD: localhost
  DOCKER_RUBY_VERSION: 2.6.5
  POSTGRES_IMAGE_TAG: 12.0
  REDIS_IMAGE_TAG: 5-alpine
  GO_IMAGE_TAG: 1.12.5
  POSTGRES_DB: photos
  POSTGRES_HOST: db
  RAILS_ENV: development

compose:
  files:
    - docker/docker-compose.yml
    - docker/docker-compose.development.yml
  project_name: photo_storage${RAILS_ENV}

interaction:
  sh:
    service: app

  irb:
    service: app
    command: irb

  bundle:
    service: app
    command: bundle

  rake:
    service: app
    command: bundle exec rake

  rails:
    service: app
    command: bundle exec rails
    subcommands:
      s:
        service: web
        compose_method: up

  rspec:
    service: app
    environment:
      RAILS_ENV: test
    command: bundle exec rspec

  psql:
    service: db
    command: psql -h ${POSTGRES_HOST} -U postgres ${POSTGRES_DB}

  go:
    service: proxy
    command: go

provision:
  - docker volume create --name bundler_data
  - dip compose up -d db
  - dip bundle install
  - dip rails db:migrate
  - dip go get -u github.com/lib/pq
